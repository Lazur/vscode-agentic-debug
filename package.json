{
  "name": "vscode-agentic-debug",
  "displayName": "Agentic Debug",
  "description": "Exposes PHP/Xdebug debugging methods as VS Code Language Model Tools for Copilot agent mode",
  "version": "0.1.0",
  "publisher": "php-agentic-debug",
  "license": "MIT",
  "engines": {
    "vscode": "^1.95.0"
  },
  "extensionDependencies": [
    "xdebug.php-debug"
  ],
  "main": "./out/extension.js",
  "activationEvents": [
    "onLanguageModelTool:debug_launch",
    "onLanguageModelTool:debug_terminate",
    "onLanguageModelTool:debug_status",
    "onLanguageModelTool:debug_continue",
    "onLanguageModelTool:debug_next",
    "onLanguageModelTool:debug_step_in",
    "onLanguageModelTool:debug_step_out",
    "onLanguageModelTool:debug_pause",
    "onLanguageModelTool:debug_breakpoints",
    "onLanguageModelTool:debug_breakpoints_get",
    "onLanguageModelTool:debug_stack_trace",
    "onLanguageModelTool:debug_scopes",
    "onLanguageModelTool:debug_variables",
    "onLanguageModelTool:debug_evaluate",
    "onLanguageModelTool:debug_threads",
    "onLanguageModelTool:debug_wait"
  ],
  "contributes": {
    "configuration": {
      "title": "Agentic Debug",
      "properties": {
        "agenticDebug.port": {
          "type": "number",
          "default": 9003,
          "description": "Xdebug listen port"
        },
        "agenticDebug.hostname": {
          "type": "string",
          "default": "127.0.0.1",
          "description": "Hostname to listen on for Xdebug connections"
        },
        "agenticDebug.stopOnEntry": {
          "type": "boolean",
          "default": true,
          "description": "Pause execution on the first line when Xdebug connects"
        },
        "agenticDebug.pathMappings": {
          "type": "object",
          "default": {},
          "description": "Path mappings from server paths to local paths",
          "additionalProperties": {
            "type": "string"
          }
        },
        "agenticDebug.maxConnections": {
          "type": "number",
          "default": 0,
          "description": "Maximum number of Xdebug connections (0 = unlimited)"
        }
      }
    },
    "languageModelTools": [
      {
        "name": "debug_launch",
        "displayName": "Debug: Launch Session",
        "canBeReferencedInPrompt": true,
        "toolReferenceName": "debugLaunch",
        "icon": "$(debug-start)",
        "modelDescription": "Start a PHP debug session. Call this FIRST before any other debug tools.\n\nIMPORTANT: Pass all parameters as FLAT top-level properties. Do NOT wrap them in a 'configuration' object.\n\nCorrect:   {\"port\": 9003, \"pathMappings\": {\"/var/www/html\": \"/local/path\"}}\nINCORRECT: {\"configuration\": {\"port\": 9003, \"pathMappings\": {...}}}\n\npathMappings: Required for Docker/remote debugging. Maps server paths to local paths so breakpoints and stack traces resolve correctly. Example: {\"/var/www/html\": \"/Users/me/project\"}. If omitted, the tool falls back to VS Code settings or launch.json.\n\nbackendMode: ALWAYS use 'ui' (default). Do NOT use 'headless' for interactive debugging — headless mode has limited thread/variable inspection and is only for non-interactive CI/batch scenarios. For stepping, inspecting variables, and setting breakpoints interactively, 'ui' mode is required.\n\nWorkflow after launching:\n1. Read the PHP source code you want to debug\n2. Call debug_launch with pathMappings if using Docker/remote\n3. Set breakpoints with debug_breakpoints at key locations\n4. Trigger PHP execution (e.g. run the script or hit the endpoint)\n5. Use debug_status to detect when Xdebug connects and hits a breakpoint\n6. Inspect state with debug_stack_trace, debug_variables, debug_evaluate\n7. Step through code with debug_next, debug_step_in, debug_step_out\n8. Continue with debug_continue or terminate with debug_terminate",
        "userDescription": "Launch a PHP/Xdebug debug session",
        "inputSchema": {
          "type": "object",
          "properties": {
            "port": {
              "type": "number",
              "description": "Xdebug listen port (default: from settings or 9003)"
            },
            "backendMode": {
              "type": "string",
              "enum": ["headless", "ui"],
              "description": "Backend mode: 'ui' for VS Code debug UI (default), 'headless' for direct DAP"
            },
            "pathMappings": {
              "type": "object",
              "additionalProperties": { "type": "string" },
              "description": "Server-to-local path mappings, e.g. {\"/var/www/html\": \"/Users/me/project\"}"
            },
            "stopOnEntry": {
              "type": "boolean",
              "description": "Pause on first line when Xdebug connects"
            },
            "hostname": {
              "type": "string",
              "description": "Hostname to listen on (default: 127.0.0.1)"
            },
            "log": {
              "type": "boolean",
              "description": "Enable xdebug.php-debug adapter logging"
            }
          }
        }
      },
      {
        "name": "debug_terminate",
        "displayName": "Debug: Terminate Session",
        "canBeReferencedInPrompt": true,
        "toolReferenceName": "debugTerminate",
        "icon": "$(debug-stop)",
        "modelDescription": "Terminate the current PHP debug session. Sends a DAP disconnect request and cleans up. After termination, call debug_launch to start a new session.",
        "userDescription": "End the current debug session",
        "inputSchema": {
          "type": "object",
          "properties": {}
        }
      },
      {
        "name": "debug_status",
        "displayName": "Debug: Session Status",
        "canBeReferencedInPrompt": true,
        "toolReferenceName": "debugStatus",
        "icon": "$(info)",
        "modelDescription": "Get current debug session state and guidance. Call AFTER triggering PHP execution to detect when Xdebug connects and hits a breakpoint. Callable in any state.\n\nState guide:\n- not_started: No session active. Call debug_launch first.\n- launching: Session is starting up. Wait and check again.\n- listening: Adapter is ready, waiting for Xdebug connection. Trigger your PHP script now.\n- connected: Xdebug connected, execution is running. Set breakpoints or call debug_pause.\n- paused: Execution stopped at a breakpoint or step. Inspect with debug_stack_trace, debug_variables, debug_evaluate. Step with debug_next, debug_step_in, debug_step_out. Resume with debug_continue.\n- terminated: Session ended. Call debug_launch to start a new session.",
        "userDescription": "Check debug session status",
        "inputSchema": {
          "type": "object",
          "properties": {}
        }
      },
      {
        "name": "debug_continue",
        "displayName": "Debug: Continue",
        "canBeReferencedInPrompt": true,
        "toolReferenceName": "debugContinue",
        "icon": "$(debug-continue)",
        "modelDescription": "Continue running until next breakpoint. Use after inspecting state at current breakpoint. Requires paused state. After continuing, use debug_status to detect when execution stops again at the next breakpoint or completes.",
        "userDescription": "Resume execution until next breakpoint",
        "inputSchema": {
          "type": "object",
          "properties": {
            "threadId": {
              "type": "number",
              "description": "Thread ID to continue (defaults to last stopped thread)"
            }
          }
        }
      },
      {
        "name": "debug_next",
        "displayName": "Debug: Step Over",
        "canBeReferencedInPrompt": true,
        "toolReferenceName": "debugNext",
        "icon": "$(debug-step-over)",
        "modelDescription": "Step over — execute current line, pause at next. Use to trace line by line without entering functions. Requires paused state. After stepping, use debug_status to detect when execution pauses at the next line.",
        "userDescription": "Step over to next line",
        "inputSchema": {
          "type": "object",
          "properties": {
            "threadId": {
              "type": "number",
              "description": "Thread ID to step over on (defaults to last stopped thread)"
            }
          }
        }
      },
      {
        "name": "debug_step_in",
        "displayName": "Debug: Step In",
        "canBeReferencedInPrompt": true,
        "toolReferenceName": "debugStepIn",
        "icon": "$(debug-step-into)",
        "modelDescription": "Step into — enter function call on current line. Use when you need to see inside a function. Requires paused state. After stepping in, use debug_status to detect when execution pauses inside the function.",
        "userDescription": "Step into function call",
        "inputSchema": {
          "type": "object",
          "properties": {
            "threadId": {
              "type": "number",
              "description": "Thread ID to step into on (defaults to last stopped thread)"
            }
          }
        }
      },
      {
        "name": "debug_step_out",
        "displayName": "Debug: Step Out",
        "canBeReferencedInPrompt": true,
        "toolReferenceName": "debugStepOut",
        "icon": "$(debug-step-out)",
        "modelDescription": "Step out — run until current function returns. Use when done inspecting this function. Requires paused state. After stepping out, use debug_status to detect when execution pauses in the calling function.",
        "userDescription": "Step out of current function",
        "inputSchema": {
          "type": "object",
          "properties": {
            "threadId": {
              "type": "number",
              "description": "Thread ID to step out on (defaults to last stopped thread)"
            }
          }
        }
      },
      {
        "name": "debug_pause",
        "displayName": "Debug: Pause",
        "canBeReferencedInPrompt": true,
        "toolReferenceName": "debugPause",
        "icon": "$(debug-pause)",
        "modelDescription": "Pause running execution. Use when execution is running and you want to inspect current state. Requires connected (running) state. After pausing, use debug_stack_trace, debug_variables, debug_evaluate to inspect.",
        "userDescription": "Pause running execution",
        "inputSchema": {
          "type": "object",
          "properties": {
            "threadId": {
              "type": "number",
              "description": "Thread ID to pause (defaults to last stopped thread)"
            }
          }
        }
      },
      {
        "name": "debug_breakpoints",
        "displayName": "Debug: Set Breakpoints",
        "canBeReferencedInPrompt": true,
        "toolReferenceName": "debugBreakpoints",
        "icon": "$(debug-breakpoint)",
        "modelDescription": "Set breakpoints in a file (replaces all existing breakpoints in that file). STRATEGY: Read source first to identify key locations — function entries, conditionals, error handlers. Set multiple across the call chain.\n\nEach call replaces ALL breakpoints in the specified file. To clear breakpoints, call with an empty array. Supports conditional breakpoints and hit conditions. Use local file paths — xdebug.php-debug handles path mapping to remote paths automatically.\n\nCan be called in listening, connected, or paused state.",
        "userDescription": "Set breakpoints in a PHP source file",
        "inputSchema": {
          "type": "object",
          "properties": {
            "path": {
              "type": "string",
              "description": "Local source file path to set breakpoints in"
            },
            "breakpoints": {
              "type": "array",
              "description": "Array of breakpoint specifications",
              "items": {
                "type": "object",
                "properties": {
                  "line": {
                    "type": "number",
                    "description": "Line number for the breakpoint"
                  },
                  "condition": {
                    "type": "string",
                    "description": "Optional condition expression"
                  },
                  "hitCondition": {
                    "type": "string",
                    "description": "Optional hit count expression"
                  }
                },
                "required": ["line"]
              }
            }
          },
          "required": ["path", "breakpoints"]
        }
      },
      {
        "name": "debug_breakpoints_get",
        "displayName": "Debug: Get Breakpoints",
        "canBeReferencedInPrompt": true,
        "toolReferenceName": "debugBreakpointsGet",
        "icon": "$(debug-breakpoint)",
        "modelDescription": "Get currently active breakpoints for a file from the BreakpointLedger. Works in both headless and UI modes. Returns breakpoints tracked by the agent during the session.",
        "userDescription": "Read current breakpoints for a file",
        "inputSchema": {
          "type": "object",
          "properties": {
            "path": {
              "type": "string",
              "description": "Source file path to get breakpoints for"
            }
          },
          "required": ["path"]
        }
      },
      {
        "name": "debug_stack_trace",
        "displayName": "Debug: Stack Trace",
        "canBeReferencedInPrompt": true,
        "toolReferenceName": "debugStackTrace",
        "icon": "$(debug-stackframe)",
        "modelDescription": "Get call stack when paused. Shows the chain of calls to current location. Each frame has an ID — use with debug_scopes and debug_evaluate to inspect that frame's context. Source file paths are returned as local paths (xdebug.php-debug handles path mapping). Requires paused state.",
        "userDescription": "View the call stack",
        "inputSchema": {
          "type": "object",
          "properties": {}
        }
      },
      {
        "name": "debug_scopes",
        "displayName": "Debug: Scopes",
        "canBeReferencedInPrompt": true,
        "toolReferenceName": "debugScopes",
        "icon": "$(symbol-namespace)",
        "modelDescription": "Get variable scopes for a stack frame. Returns available scopes (locals, globals, superglobals) with their variablesReference values. Use the frameId from debug_stack_trace. Then use the returned variablesReference with debug_variables to inspect variables in each scope. Requires paused state.",
        "userDescription": "View variable scopes for a stack frame",
        "inputSchema": {
          "type": "object",
          "properties": {
            "frameId": {
              "type": "number",
              "description": "Stack frame ID from debug_stack_trace"
            }
          },
          "required": ["frameId"]
        }
      },
      {
        "name": "debug_variables",
        "displayName": "Debug: Variables",
        "canBeReferencedInPrompt": true,
        "toolReferenceName": "debugVariables",
        "icon": "$(symbol-variable)",
        "modelDescription": "Get variables for a scope or object. Returns variable names, values, types. Use variablesReference to drill into objects/arrays — the variablesReference comes from debug_scopes (for top-level scopes), debug_evaluate (for expression results), or a previous debug_variables call (for nested objects/arrays). Requires paused state.",
        "userDescription": "Inspect variables in a scope",
        "inputSchema": {
          "type": "object",
          "properties": {
            "variablesReference": {
              "type": "number",
              "description": "Variables reference ID from scopes, evaluate, or another variables response"
            },
            "start": {
              "type": "number",
              "description": "Start index for paged results"
            },
            "count": {
              "type": "number",
              "description": "Number of variables to return"
            }
          },
          "required": ["variablesReference"]
        }
      },
      {
        "name": "debug_evaluate",
        "displayName": "Debug: Evaluate",
        "canBeReferencedInPrompt": true,
        "toolReferenceName": "debugEvaluate",
        "icon": "$(terminal)",
        "modelDescription": "Evaluate PHP expression in paused context. Examples: '$user->getRoles()', 'count($items)', '$request->getMethod()'. Use to test hypotheses about bugs. Use frameId from debug_stack_trace to evaluate in a specific stack frame's context. Returns the result value, type, and a variablesReference for drilling into objects/arrays with debug_variables. Requires paused state.",
        "userDescription": "Evaluate a PHP expression",
        "inputSchema": {
          "type": "object",
          "properties": {
            "expression": {
              "type": "string",
              "description": "PHP expression to evaluate"
            },
            "frameId": {
              "type": "number",
              "description": "Stack frame ID to evaluate in (defaults to top frame)"
            },
            "context": {
              "type": "string",
              "enum": ["repl", "watch", "hover"],
              "description": "Evaluation context"
            }
          },
          "required": ["expression"]
        }
      },
      {
        "name": "debug_threads",
        "displayName": "Debug: Threads",
        "canBeReferencedInPrompt": true,
        "toolReferenceName": "debugThreads",
        "icon": "$(list-tree)",
        "modelDescription": "List all active threads in the debug session. Returns thread IDs and names. Use thread IDs with step/continue commands and debug_stack_trace. Requires connected or paused state.",
        "userDescription": "List active debug threads",
        "inputSchema": {
          "type": "object",
          "properties": {}
        }
      },
      {
        "name": "debug_wait",
        "displayName": "Debug: Wait for Event",
        "canBeReferencedInPrompt": true,
        "toolReferenceName": "debugWait",
        "icon": "$(watch)",
        "modelDescription": "Block until a debug event occurs (stopped, thread started, terminated, continued). Use INSTEAD of polling debug_status in a loop.\n\nCall this after debug_continue, debug_next, debug_step_in, debug_step_out, or debug_launch to wait for the debugger to reach the next state.\n\nReturns immediately if the session is already paused.\n\nReturns: { reason, event, body, status } where reason is 'event', 'already_paused', 'timeout', or 'cancelled'.",
        "userDescription": "Wait for the next debug event (breakpoint hit, step complete, etc.)",
        "inputSchema": {
          "type": "object",
          "properties": {
            "timeout": {
              "type": "number",
              "description": "Maximum wait time in milliseconds (default: 30000)"
            }
          }
        }
      }
    ]
  },
  "scripts": {
    "build": "tsc",
    "bundle": "esbuild src/extension.ts --bundle --outfile=out/extension.js --external:vscode --format=cjs --platform=node --sourcemap",
    "package": "npm run bundle && vsce package --allow-missing-repository",
    "test": "vitest --run"
  },
  "devDependencies": {
    "ts-php-debug-mcp": "file:../ts-php-debug-mcp",
    "@types/vscode": "^1.95.0",
    "@types/node": "^25.2.3",
    "@vscode/debugprotocol": "^1.68.0",
    "esbuild": "^0.27.3",
    "fast-check": "^4.5.3",
    "typescript": "^5.9.3",
    "vitest": "^4.0.18"
  }
}
