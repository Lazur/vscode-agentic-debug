{
  "name": "vscode-agentic-debug",
  "displayName": "Agentic Debug",
  "description": "Exposes PHP/Xdebug debugging as VS Code Language Model Tools for Copilot agent mode",
  "version": "0.1.0",
  "publisher": "php-debug-mcp",
  "license": "MIT",
  "engines": {
    "vscode": "^1.95.0"
  },
  "extensionDependencies": [
    "xdebug.php-debug"
  ],
  "main": "./out/extension.js",
  "activationEvents": [
    "onLanguageModelTool:debug_launch",
    "onDebugResolve:php-agent"
  ],
  "contributes": {
    "debuggers": [
      {
        "type": "php-agent",
        "label": "PHP (Agent-Controlled)",
        "configurationAttributes": {
          "launch": {
            "properties": {
              "backendMode": {
                "type": "string",
                "enum": ["headless", "ui"],
                "description": "Backend mode: headless (direct DAP) or ui (VS Code debug UI)",
                "default": "ui"
              },
              "agentSessionId": {
                "type": "string",
                "description": "Internal agent session tracking identifier"
              }
            }
          }
        }
      }
    ],
    "configuration": {
      "title": "Agentic Debug",
      "properties": {
        "agenticDebug.port": {
          "type": "number",
          "default": 9003,
          "description": "Xdebug listen port"
        },
        "agenticDebug.hostname": {
          "type": "string",
          "default": "127.0.0.1",
          "description": "Hostname to listen on for Xdebug connections"
        },
        "agenticDebug.stopOnEntry": {
          "type": "boolean",
          "default": true,
          "description": "Pause execution on the first line when Xdebug connects"
        },
        "agenticDebug.pathMappings": {
          "type": "object",
          "default": {},
          "description": "Path mappings from server paths to local paths",
          "additionalProperties": {
            "type": "string"
          }
        },
        "agenticDebug.maxConnections": {
          "type": "number",
          "default": 0,
          "description": "Maximum number of Xdebug connections (0 = unlimited)"
        }
      }
    },
    "languageModelTools": [
      {
        "name": "debug_launch",
        "displayName": "Debug: Launch Session",
        "canBeReferencedInPrompt": true,
        "toolReferenceName": "debugLaunch",
        "icon": "$(debug-start)",
        "modelDescription": "Start a PHP debug session. Choose backendMode 'ui' for visual/collaborative debugging with VS Code debug UI, or 'headless' for automated/background debugging. Call this FIRST before any other debug tools. After launching, set breakpoints, trigger PHP execution, then use debug_status to detect breakpoint hits.",
        "userDescription": "Launch a PHP/Xdebug debug session",
        "inputSchema": {
          "type": "object",
          "properties": {
            "port": {
              "type": "number",
              "description": "Xdebug listen port (default: from settings or 9003)"
            },
            "backendMode": {
              "type": "string",
              "enum": ["headless", "ui"],
              "description": "Backend mode: 'ui' for VS Code debug UI (default), 'headless' for direct DAP"
            },
            "pathMappings": {
              "type": "object",
              "additionalProperties": { "type": "string" },
              "description": "Server-to-local path mappings (Record<string, string>)"
            },
            "stopOnEntry": {
              "type": "boolean",
              "description": "Pause on first line when Xdebug connects"
            }
          }
        }
      },
      {
        "name": "debug_terminate",
        "displayName": "Debug: Terminate Session",
        "canBeReferencedInPrompt": true,
        "toolReferenceName": "debugTerminate",
        "icon": "$(debug-stop)",
        "modelDescription": "Terminate the current PHP debug session. Sends a DAP disconnect request and cleans up. After termination, call debug_launch to start a new session.",
        "userDescription": "End the current debug session",
        "inputSchema": {
          "type": "object",
          "properties": {}
        }
      },
      {
        "name": "debug_status",
        "displayName": "Debug: Session Status",
        "canBeReferencedInPrompt": true,
        "toolReferenceName": "debugStatus",
        "icon": "$(info)",
        "modelDescription": "Get current debug session state and guidance. States: not_started, initializing, listening, connected, paused, terminated. Call after triggering PHP execution to detect breakpoint hits. Callable in any state.",
        "userDescription": "Check debug session status",
        "inputSchema": {
          "type": "object",
          "properties": {}
        }
      },
      {
        "name": "debug_continue",
        "displayName": "Debug: Continue",
        "canBeReferencedInPrompt": true,
        "toolReferenceName": "debugContinue",
        "icon": "$(debug-continue)",
        "modelDescription": "Continue execution until next breakpoint. Requires paused state. After continuing, use debug_status to detect next stop.",
        "userDescription": "Resume execution until next breakpoint",
        "inputSchema": {
          "type": "object",
          "properties": {
            "threadId": {
              "type": "number",
              "description": "Thread ID to continue (defaults to last stopped thread)"
            }
          }
        }
      },
      {
        "name": "debug_next",
        "displayName": "Debug: Step Over",
        "canBeReferencedInPrompt": true,
        "toolReferenceName": "debugNext",
        "icon": "$(debug-step-over)",
        "modelDescription": "Step over — execute current line, pause at next line. Does not enter function calls. Requires paused state.",
        "userDescription": "Step over to next line",
        "inputSchema": {
          "type": "object",
          "properties": {
            "threadId": {
              "type": "number",
              "description": "Thread ID to step over on (defaults to last stopped thread)"
            }
          }
        }
      },
      {
        "name": "debug_step_in",
        "displayName": "Debug: Step In",
        "canBeReferencedInPrompt": true,
        "toolReferenceName": "debugStepIn",
        "icon": "$(debug-step-into)",
        "modelDescription": "Step into — enter function call on current line. Use to inspect inside a function. Requires paused state.",
        "userDescription": "Step into function call",
        "inputSchema": {
          "type": "object",
          "properties": {
            "threadId": {
              "type": "number",
              "description": "Thread ID to step into on (defaults to last stopped thread)"
            }
          }
        }
      },
      {
        "name": "debug_step_out",
        "displayName": "Debug: Step Out",
        "canBeReferencedInPrompt": true,
        "toolReferenceName": "debugStepOut",
        "icon": "$(debug-step-out)",
        "modelDescription": "Step out — run until current function returns. Use when done inspecting a function. Requires paused state.",
        "userDescription": "Step out of current function",
        "inputSchema": {
          "type": "object",
          "properties": {
            "threadId": {
              "type": "number",
              "description": "Thread ID to step out on (defaults to last stopped thread)"
            }
          }
        }
      },
      {
        "name": "debug_pause",
        "displayName": "Debug: Pause",
        "canBeReferencedInPrompt": true,
        "toolReferenceName": "debugPause",
        "icon": "$(debug-pause)",
        "modelDescription": "Pause running execution. Requires connected (running) state. After pausing, inspect with debug_stack_trace, debug_variables, debug_evaluate.",
        "userDescription": "Pause running execution",
        "inputSchema": {
          "type": "object",
          "properties": {
            "threadId": {
              "type": "number",
              "description": "Thread ID to pause (defaults to last stopped thread)"
            }
          }
        }
      },
      {
        "name": "debug_breakpoints",
        "displayName": "Debug: Set Breakpoints",
        "canBeReferencedInPrompt": true,
        "toolReferenceName": "debugBreakpoints",
        "icon": "$(debug-breakpoint)",
        "modelDescription": "Set breakpoints in a file (replaces all existing breakpoints in that file). Read source first to identify key locations. Supports conditional breakpoints and hit conditions. Can be called in listening, connected, or paused state.",
        "userDescription": "Set breakpoints in a PHP source file",
        "inputSchema": {
          "type": "object",
          "properties": {
            "path": {
              "type": "string",
              "description": "Local source file path to set breakpoints in"
            },
            "breakpoints": {
              "type": "array",
              "description": "Array of breakpoint specifications",
              "items": {
                "type": "object",
                "properties": {
                  "line": {
                    "type": "number",
                    "description": "Line number for the breakpoint"
                  },
                  "condition": {
                    "type": "string",
                    "description": "Optional condition expression"
                  },
                  "hitCondition": {
                    "type": "string",
                    "description": "Optional hit count expression"
                  }
                },
                "required": ["line"]
              }
            }
          },
          "required": ["path", "breakpoints"]
        }
      },
      {
        "name": "debug_breakpoints_get",
        "displayName": "Debug: Get Breakpoints",
        "canBeReferencedInPrompt": true,
        "toolReferenceName": "debugBreakpointsGet",
        "icon": "$(debug-breakpoint)",
        "modelDescription": "Get currently active breakpoints for a file from the BreakpointLedger. Works in both headless and UI modes. Returns breakpoints tracked by the agent during the session.",
        "userDescription": "Read current breakpoints for a file",
        "inputSchema": {
          "type": "object",
          "properties": {
            "path": {
              "type": "string",
              "description": "Source file path to get breakpoints for"
            }
          },
          "required": ["path"]
        }
      },
      {
        "name": "debug_stack_trace",
        "displayName": "Debug: Stack Trace",
        "canBeReferencedInPrompt": true,
        "toolReferenceName": "debugStackTrace",
        "icon": "$(debug-stackframe)",
        "modelDescription": "Get call stack when paused. Shows chain of function calls to current location. Each frame has an ID for use with debug_scopes and debug_evaluate. Requires paused state.",
        "userDescription": "View the call stack",
        "inputSchema": {
          "type": "object",
          "properties": {}
        }
      },
      {
        "name": "debug_scopes",
        "displayName": "Debug: Scopes",
        "canBeReferencedInPrompt": true,
        "toolReferenceName": "debugScopes",
        "icon": "$(symbol-namespace)",
        "modelDescription": "Get variable scopes for a stack frame. Returns locals, globals, superglobals with variablesReference values. Use frameId from debug_stack_trace. Requires paused state.",
        "userDescription": "View variable scopes for a stack frame",
        "inputSchema": {
          "type": "object",
          "properties": {
            "frameId": {
              "type": "number",
              "description": "Stack frame ID from debug_stack_trace"
            }
          },
          "required": ["frameId"]
        }
      },
      {
        "name": "debug_variables",
        "displayName": "Debug: Variables",
        "canBeReferencedInPrompt": true,
        "toolReferenceName": "debugVariables",
        "icon": "$(symbol-variable)",
        "modelDescription": "Get variables for a scope or object. Use variablesReference from debug_scopes, debug_evaluate, or a previous debug_variables call to drill into nested objects/arrays. Requires paused state.",
        "userDescription": "Inspect variables in a scope",
        "inputSchema": {
          "type": "object",
          "properties": {
            "variablesReference": {
              "type": "number",
              "description": "Variables reference ID from scopes, evaluate, or another variables response"
            },
            "start": {
              "type": "number",
              "description": "Start index for paged results"
            },
            "count": {
              "type": "number",
              "description": "Number of variables to return"
            }
          },
          "required": ["variablesReference"]
        }
      },
      {
        "name": "debug_evaluate",
        "displayName": "Debug: Evaluate",
        "canBeReferencedInPrompt": true,
        "toolReferenceName": "debugEvaluate",
        "icon": "$(terminal)",
        "modelDescription": "Evaluate a PHP expression in paused context. Examples: '$user->getRoles()', 'count($items)'. Use frameId from debug_stack_trace to evaluate in a specific frame. Requires paused state.",
        "userDescription": "Evaluate a PHP expression",
        "inputSchema": {
          "type": "object",
          "properties": {
            "expression": {
              "type": "string",
              "description": "PHP expression to evaluate"
            },
            "frameId": {
              "type": "number",
              "description": "Stack frame ID to evaluate in (defaults to top frame)"
            },
            "context": {
              "type": "string",
              "enum": ["repl", "watch", "hover"],
              "description": "Evaluation context"
            }
          },
          "required": ["expression"]
        }
      },
      {
        "name": "debug_threads",
        "displayName": "Debug: Threads",
        "canBeReferencedInPrompt": true,
        "toolReferenceName": "debugThreads",
        "icon": "$(list-tree)",
        "modelDescription": "List all active threads in the debug session. Returns thread IDs and names. Use thread IDs with step/continue commands. Requires connected or paused state.",
        "userDescription": "List active debug threads",
        "inputSchema": {
          "type": "object",
          "properties": {}
        }
      }
    ]
  },
  "scripts": {
    "build": "tsc",
    "bundle": "esbuild src/extension.ts --bundle --outfile=out/extension.js --external:vscode --format=cjs --platform=node --sourcemap",
    "test": "vitest --run"
  },
  "dependencies": {
    "ts-php-debug-mcp": "file:../ts-php-debug-mcp"
  },
  "devDependencies": {
    "@types/vscode": "^1.95.0",
    "@types/node": "^25.2.3",
    "@vscode/debugprotocol": "^1.68.0",
    "esbuild": "^0.27.3",
    "fast-check": "^4.5.3",
    "typescript": "^5.9.3",
    "vitest": "^4.0.18"
  }
}
